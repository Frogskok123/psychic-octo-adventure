name: Build hack.ko for 4.19.312-perf+

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout module source
      uses: actions/checkout@v4

    - name: Install clang-17 & lld
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-17 lld llvm

    - name: Clone AOSP common-android-4.19
      run: |
        git clone --depth=1 https://android.googlesource.com/kernel/common.git -b common-android-4.19 kernel

    - name: Prepare kernel
      run: |
        cd kernel
        make ARCH=arm64 CC=clang LD=ld.lld defconfig
        make ARCH=arm64 CC=clang LD=ld.lld prepare modules_prepare

    - name: Build module
      run: |
        make -C kernel M=$PWD ARCH=arm64 CC=clang LD=ld.lld modules

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: hack-4.19.312.ko
        path: hack.ko

